{
  "$schema": "https://vega.github.io/schema/vega-lite/v6.json",
  "description": "Waterfall chart of Tourism GDP ($b) with Begin and End bars from CSV.",
  "data": {
    "url": "https://raw.githubusercontent.com/NabilaCodes/FIT3179-DV-2/refs/heads/main/Tourism%20GDP%20by%20year.csv"
  },
  "width": 800,
  "height": 450,
  "transform": [
    { "calculate": "datum.Year", "as": "label" },
    { "calculate": "toNumber(replace(datum['Tourism ($b)'], ',', ''))", "as": "Value" },
    { "window": [{ "op": "row_number", "as": "ord" }] },
    {
      "window": [
        { "op": "lag",  "field": "Value", "as": "prev_value" },
        { "op": "lead", "field": "Value", "as": "next_value" }
      ],
      "sort": [{ "field": "ord", "order": "ascending" }]
    },
    {
      "calculate": "datum.label === 'Begin' ? datum.next_value : (datum.label === 'End' ? 0 : datum.Value - datum.prev_value)",
      "as": "amount"
    },
    {
      "window": [{ "op": "sum", "field": "amount", "as": "sum" }],
      "sort": [{ "field": "ord", "order": "ascending" }]
    },
    {
      "window": [{ "op": "lead", "field": "label", "as": "lead" }],
      "sort": [{ "field": "ord", "order": "ascending" }]
    },
    { "calculate": "datum.lead === null ? datum.label : datum.lead", "as": "lead" },
    { "calculate": "datum.label === 'End' ? 0 : datum.sum - datum.amount", "as": "previous_sum" },
    { "calculate": "datum.label === 'End' ? datum.sum : datum.amount", "as": "amount" },
    { "calculate": "(datum.label !== 'Begin' && datum.label !== 'End' && datum.amount > 0 ? '+' : '') + format(datum.amount, '.3f')", "as": "text_amount" },
    { "calculate": "(datum.sum + datum.previous_sum) / 2", "as": "center" }
  ],
  "encoding": {
    "x": {
      "field": "label",
      "type": "ordinal",
      "axis": { "labelAngle": 0, "title": "Financial Year" },
      "sort": [
        "Begin",
        "2016-17",
        "2017-18",
        "2018-19",
        "2019-20",
        "2020-21",
        "2021-22",
        "2022-23",
        "2023-24",
        "End"
      ]
    }
  },
  "layer": [
    {
      "mark": { "type": "bar", "size": 45 },
      "encoding": {
        "y": { "field": "previous_sum", "type": "quantitative", "title": "Amount ($ billions)" },
        "y2": { "field": "sum" },
        "color": {
          "condition": [
            { "test": "datum.label === 'Begin' || datum.label === 'End'", "value": "#f7e0b6" },
            { "test": "datum.sum < datum.previous_sum", "value": "#e57373" }
          ],
          "value": "#5b9bd5"
        },
        "tooltip": [
          { "field": "label", "title": "Year" },
          { "field": "Value", "type": "quantitative", "title": "Tourism GDP (total, $b)", "format": ".3f" },
          { "field": "amount", "type": "quantitative", "title": "Step amount ($b)", "format": ".3f" },
          { "field": "sum", "type": "quantitative", "title": "Cumulative ($b)", "format": ".3f" }
        ]
      }
    },
    {
      "mark": { "type": "rule", "color": "#404040", "opacity": 1, "strokeWidth": 2, "xOffset": -22.5, "x2Offset": 22.5 },
      "encoding": { "x2": { "field": "lead" }, "y": { "field": "sum", "type": "quantitative" } }
    },
    {
      "mark": { "type": "text", "dy": { "expr": "datum.amount >= 0 ? -4 : 4" }, "baseline": { "expr": "datum.amount >= 0 ? 'bottom' : 'top'" } },
      "encoding": { "y": { "field": "sum", "type": "quantitative" }, "text": { "field": "sum", "type": "quantitative", "format": ".3f" } }
    },
    {
      "mark": { "type": "text", "fontWeight": "bold", "baseline": "middle" },
      "encoding": {
        "y": { "field": "center", "type": "quantitative" },
        "text": { "field": "text_amount", "type": "nominal" },
        "color": {
          "condition": [{ "test": "datum.label === 'Begin' || datum.label === 'End'", "value": "#725a30" }],
          "value": "white"
        }
      }
    }
  ],
  "config": {
    "text": { "font": "Segoe UI", "fontWeight": "bold", "color": "#404040" },
    "axis": {
      "labelFont": "Segoe UI",
      "titleFont": "Segoe UI",
      "labelFontSize": 12,
      "titleFontSize": 13,
      "labelColor": "#00334d",
      "titleColor": "#00334d"
    },
    "title": {
      "font": "Segoe UI",
      "fontSize": 20,
      "fontWeight": "normal",
      "color": "#00334d"
    }
  }
}
